rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- users ---
    match /users/{uid} {
      allow read: if request.auth != null; // don't leave as true in a real app
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // --- relationships ---
    // Doc id format: "<uidA>_<uidB>" where uidA < uidB (sorted)
    match /relationships/{pairId} {
      allow read: if request.auth != null;

      allow create, update, delete: if request.auth != null
        && (request.auth.uid == request.resource.data.uidA
            || request.auth.uid == request.resource.data.uidB);
    }

    // --- locations (MAPS) ---
    match /locations/{uid} {
      // user can write ONLY their own location doc
      allow create, update: if request.auth != null && request.auth.uid == uid
        && request.resource.data.keys().hasOnly([
          "lat","lng","visible","radiusMeters","visibilityMode","updatedAt"
        ])
        && request.resource.data.lat is number
        && request.resource.data.lng is number
        && request.resource.data.visible is bool
        && request.resource.data.radiusMeters is number
        && request.resource.data.visibilityMode in ["public", "friends", "hidden"];

      // Read if:
      // - user is reading self
      // OR location is visible AND (public OR friends AND friendship exists)
      allow read: if request.auth != null && (
        request.auth.uid == uid
        ||
        (
          resource.data.visible == true
          && resource.data.visibilityMode != "hidden"
          && (
            resource.data.visibilityMode == "public"
            ||
            isFriends(request.auth.uid, uid)
          )
        )
      );

      allow delete: if false;
    }

    // --- chats ---
    match /chats/{chatId} {
      allow read: if request.auth != null
                  && request.auth.uid in resource.data.members;

      allow create: if request.auth != null
                    && request.resource.data.members is list
                    && request.auth.uid in request.resource.data.members;

      allow update, delete: if request.auth != null
                            && request.auth.uid in resource.data.members;
    }

    function isFriends(a, b) {
      return exists(/databases/$(database)/documents/relationships/$(pairKey(a,b)))
        && get(/databases/$(database)/documents/relationships/$(pairKey(a,b))).data.status == "accepted";
    }

    function pairKey(a, b) {
      return a < b ? (a + "_" + b) : (b + "_" + a);
    }
  }
}

