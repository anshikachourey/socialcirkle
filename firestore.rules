rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isMe(uid) { return signedIn() && request.auth.uid == uid; }

    match /users/{uid} {
      allow read: if true;
      allow write: if isMe(uid);
    }

    match /userSettings/{uid} {
      allow read, write: if isMe(uid);
    }

    match /userLocations/{uid} {
      allow read: if signedIn();          // you can tighten later
      allow write: if isMe(uid);
    }

    match /relationshipRequests/{id} {
      allow create: if signedIn()
        && request.resource.data.fromUid == request.auth.uid;

      allow read: if signedIn()
        && (resource.data.fromUid == request.auth.uid
            || resource.data.toUid == request.auth.uid);

      allow update: if signedIn()
        && resource.data.toUid == request.auth.uid;

      allow delete: if false;
    }

    match /cirkles/{cirkleId} {
      allow read: if signedIn();
      allow create: if signedIn()
        && request.resource.data.ownerId == request.auth.uid;

      allow update: if signedIn()
        && (resource.data.ownerId == request.auth.uid
            || request.auth.uid in resource.data.members);
    }

    match /announcements/{id} {
      allow create: if signedIn(); // tighten later (owner only)
      allow read: if signedIn();
      allow update, delete: if false;
    }

    match /feeds/{uid} {
      allow read: if isMe(uid);
      allow write: if false;

      match /items/{itemId} {
        allow read: if isMe(uid);
        allow write: if false; // only Cloud Function writes
      }
    }

    match /chats/{chatId} {
      allow read: if signedIn() && request.auth.uid in resource.data.members;
      allow create: if signedIn()
        && request.resource.data.members is list
        && request.auth.uid in request.resource.data.members;
      allow update, delete: if signedIn()
        && request.auth.uid in resource.data.members;

      match /messages/{messageId} {
        allow read: if signedIn()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;

        allow create: if signedIn()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;

        allow update, delete: if false;
      }
    }
  }
}
